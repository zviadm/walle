syntax = "proto3";

import "walleapi/walleapi.proto";

service Walle {
	rpc NewWriter(NewWriterRequest) returns (NewWriterResponse) {}
	rpc PutEntryInternal(PutEntryInternalRequest) returns (PutEntryInternalResponse) {}

	rpc LastEntry(LastEntryRequest) returns (LastEntryResponse) {}
	//rpc ReadEntries(ReadEntriesRequest) returns (stream Entry) {}
}

message StreamTopology {
	int64 version = 1;
	repeated string server_ids = 2;
}

message NewWriterRequest {
	string server_id = 1;
	string stream_uri = 2;
	int64 stream_version = 3;

	string writer_id = 4;
}
message NewWriterResponse {}

message PutEntryInternalRequest {
	string server_id = 1;
	string stream_uri = 2;
	int64 stream_version = 3;

	Entry entry = 4;
	int64 committed_entry_id = 5;
	bytes committed_entry_md5 = 6;
}
message PutEntryInternalResponse{}

message LastEntryRequest {
	string server_id = 1;
	string stream_uri = 2;
	int64 stream_version = 3;

	bool include_uncommitted = 4;
}
message LastEntryResponse {
	repeated Entry entries = 1;
}

// message ReadEntriesRequest {
// 	string stream_uri = 1;
// 	string target_server_id = 2;
// 	int64 stream_version = 3;
//
// 	// if from_entry_id is <0, will start streaming latest entries.
// 	int64 from_entry_id = 4;
// }